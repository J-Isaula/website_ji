<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juan Isaula">
<meta name="dcterms.date" content="2023-08-07">

<title>Juan Isaula - Time Series Forecasting with XGBoost</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Juan Isaula - Time Series Forecasting with XGBoost">
<meta property="og:description" content="Utilizando Machine Learning Forecast MLForecast">
<meta property="og:image" content="https://mm218.dev/posts/XGBoost/fondo.jpeg">
<meta property="og:site-name" content="Juan Isaula">
<meta property="og:locale" content="en_US">
<meta name="twitter:title" content="Juan Isaula - Time Series Forecasting with XGBoost">
<meta name="twitter:description" content="Utilizando Machine Learning Forecast MLForecast">
<meta name="twitter:image" content="https://mm218.dev/posts/XGBoost/fondo.jpeg">
<meta name="twitter:creator" content="@MikeMahoney218">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Juan Isaula</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../papers" rel="" target="">
 <span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations" rel="" target="">
 <span class="menu-text">Cursos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Dashboards</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sobre_juan.html" rel="" target="">
 <span class="menu-text">Historias</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#mlforecast" id="toc-mlforecast" class="nav-link active" data-scroll-target="#mlforecast">MLForecast</a>
  <ul class="collapse">
  <li><a href="#por-qué-utilizar-mlforecast" id="toc-por-qué-utilizar-mlforecast" class="nav-link" data-scroll-target="#por-qué-utilizar-mlforecast">¿Por qué utilizar MLForecast?</a></li>
  <li><a href="#características" id="toc-características" class="nav-link" data-scroll-target="#características">Características</a></li>
  <li><a href="#validación-cruzada" id="toc-validación-cruzada" class="nav-link" data-scroll-target="#validación-cruzada">Validación Cruzada</a>
  <ul class="collapse">
  <li><a href="#cómo-realizar-validación-cruzada-de-series-de-tiempo" id="toc-cómo-realizar-validación-cruzada-de-series-de-tiempo" class="nav-link" data-scroll-target="#cómo-realizar-validación-cruzada-de-series-de-tiempo">¿Cómo realizar validación cruzada de series de tiempo?</a></li>
  <li><a href="#evaluar-resultados" id="toc-evaluar-resultados" class="nav-link" data-scroll-target="#evaluar-resultados">Evaluar Resultados</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#modelo-xgboost" id="toc-modelo-xgboost" class="nav-link" data-scroll-target="#modelo-xgboost">Modelo XGBoost</a>
  <ul class="collapse">
  <li><a href="#toerema-del-modelo-xgboost" id="toc-toerema-del-modelo-xgboost" class="nav-link" data-scroll-target="#toerema-del-modelo-xgboost">Toerema del Modelo XGBoost</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#modelo-xgboost-matemáticamente" id="toc-modelo-xgboost-matemáticamente" class="nav-link" data-scroll-target="#modelo-xgboost-matemáticamente">Modelo XGBoost Matemáticamente</a></li>
  <li><a href="#xgboost-para-series-de-tiempo" id="toc-xgboost-para-series-de-tiempo" class="nav-link" data-scroll-target="#xgboost-para-series-de-tiempo">XGBoost para series de tiempo</a></li>
  </ul></li>
  <li><a href="#caso-de-estudio" id="toc-caso-de-estudio" class="nav-link" data-scroll-target="#caso-de-estudio">Caso de estudio</a>
  <ul class="collapse">
  <li><a href="#cargar-datos" id="toc-cargar-datos" class="nav-link" data-scroll-target="#cargar-datos">Cargar datos</a></li>
  <li><a href="#detección-de-picos" id="toc-detección-de-picos" class="nav-link" data-scroll-target="#detección-de-picos">Detección de Picos</a></li>
  </ul></li>
  <li><a href="#referencias" id="toc-referencias" class="nav-link" data-scroll-target="#referencias">Referencias</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Time Series Forecasting with XGBoost</h1>
<p class="subtitle lead">Utilizando Machine Learning Forecast [MLForecast]</p>
  <div class="quarto-categories">
    <div class="quarto-category">XGBoost</div>
    <div class="quarto-category">MLForecast</div>
    <div class="quarto-category">Python</div>
    <div class="quarto-category">sklearn</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Juan Isaula </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 7, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="mlforecast" class="level1">
<h1>MLForecast</h1>
<p><code>MLForecast</code> es un marco de datos para realizar pronósticos de series de tiempo utilizando modelos de aprendizaje automático, con la opción de escalar a cantidades masivas de datos utilizando clústeres remotos.</p>
<section id="por-qué-utilizar-mlforecast" class="level3">
<h3 class="anchored" data-anchor-id="por-qué-utilizar-mlforecast">¿Por qué utilizar MLForecast?</h3>
<p>Las alternativas actuales de Python para los modelos de aprendizaje automático son lentas, imprecisas y no escalan bien. Así que se crearón una biblioteca que se puede usar para hacer pronósticos en entornos de producción. <code>MLForecast</code> incluye ingeniería de características eficientes para entrenar cualquier modelo de aprendizaje automático (con <code>fit</code> y <code>predict</code> métodos como <code>sklearn</code>) para adaptarse a millones de series temporales.</p>
</section>
<section id="características" class="level2">
<h2 class="anchored" data-anchor-id="características">Características</h2>
<ul>
<li><p>Las implementaciones más rapidas de ingeniería de funciones para la previsión de series temporales en Python.</p></li>
<li><p>Compatibilidad lista para usar con Spark, Dask y Ray</p></li>
<li><p>Pronósticos probabilísticos con predicción conforme.</p></li>
<li><p>Soporte para variables exógenas y covariables estáticas.</p></li>
<li><p>Sintaxis familiar <code>sklearn:</code> <code>.fit</code> y <code>.predict</code></p></li>
</ul>
</section>
<section id="validación-cruzada" class="level2">
<h2 class="anchored" data-anchor-id="validación-cruzada">Validación Cruzada</h2>
<p>La validación cruzada de series temporales es un método para evaluar cómo se habría comportado un modelo en el pasado. Funciona definiendo una ventana deslizante a través de los datos históricos y prediciendo el período que le sigue.</p>
<p><code>MLForecast</code> tiene una implementación de validación cruzada de series de tiempo que es rápida y fácil de usar. Esta implementación hace que la validación cruzada sea una operación eficiente, lo que hace que consuma menos tiempo.</p>
<section id="cómo-realizar-validación-cruzada-de-series-de-tiempo" class="level3">
<h3 class="anchored" data-anchor-id="cómo-realizar-validación-cruzada-de-series-de-tiempo">¿Cómo realizar validación cruzada de series de tiempo?</h3>
<p>Una vez que se ha instanciado el objeto <code>MLForecast</code>, podemos usar el método <code>cross_validation</code>, que toma los siguientes argumentos:</p>
<ul>
<li><p><code>data:</code> marco de datos de entrenamiento con formato MLForecast.</p></li>
<li><p><code>window_size</code>(int)<code>:</code> representa los <strong><em>h</em></strong> pasos hacia el futuro que se pronosticarán</p></li>
<li><p><code>n_windows</code> (int)<code>:</code> cantidad de ventanas utilizadas para la validación cruzada, es decir, la cantidad de procesos de pronóstico en el pasado que desea evaluar.</p></li>
<li><p><code>id_col:</code> identifica cada serie temporal</p></li>
<li><p><code>time_col:</code> identifica la columna de la serie temporal</p></li>
<li><p><code>target_col:</code> identifica la columna a modelar</p></li>
</ul>
<p>El objeto <strong><code>crossvaldation_df</code></strong> es un nuevo marco de datos que incluye las siguientes columnas:</p>
<ul>
<li><p><code>unique_id:</code> identifica cada serie temporal</p></li>
<li><p><code>ds:</code> marca de fecha o índice temporal</p></li>
<li><p><code>cutoff:</code> la última marca de fecha o índice temporal del <strong><em>n_windows</em></strong></p></li>
<li><p><code>model:</code> columnas con el nombre del modelo y el valor ajustado.</p></li>
</ul>
</section>
<section id="evaluar-resultados" class="level3">
<h3 class="anchored" data-anchor-id="evaluar-resultados">Evaluar Resultados</h3>
<p>Una vez hecho todo lo anterior, podremos calcular la precisión del pronóstico utilizando una métrica de precisión adecuada. En mi caso particular uso el error cuadrático medio (RMSE). Para hacer esto, primero debemos instalar <code>datasetsforecast</code>, una biblioteca de Python desarrollada por <strong><code>Nixtla</code></strong> que incluye una función para calcular el RMSE.</p>
<p>La función para calcular el RMSE toma dos argumentos:</p>
<ol type="1">
<li>Los valores reales</li>
<li>Las predicciones</li>
</ol>
<p>Esta medida debería reflejar mejor las capacidades predictivas de nuestro modelo, ya que utilizo diferentes periodos de tiempo para probar su precisión.</p>
</section>
</section>
</section>
<section id="modelo-xgboost" class="level1">
<h1>Modelo XGBoost</h1>
<p>El modelo XGBoost es un algoritmo de aprendizaje automático supervisado basado en árboles de decisión. Se utiliza para problemas de <strong>regresión</strong> y <strong>clasificación</strong>, se ha convertido en uno de los modelos más importantes y efectivos en las competencias de aprendizaje automático.</p>
<section id="toerema-del-modelo-xgboost" class="level2">
<h2 class="anchored" data-anchor-id="toerema-del-modelo-xgboost">Toerema del Modelo XGBoost</h2>
<p>Dados los datos de entrenamiento <span class="math inline">\(D = (x_1, y_1), (x_2, y_2), . . . , (x_n, y_n)\)</span> donde cada <span class="math inline">\(x_i\)</span> es un vector de características de entrada y cada <span class="math inline">\(y_i\)</span> es la etiqueta de salida correspondiente, el objetivo es encontrar una función <span class="math inline">\(f(x)\)</span> que mapee los vectores de características a las etiquetas de salida y minimice el error de predicción en el conjunto de entrenamiento.</p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<p>La construcción del modelo implica la creación de un conjunto de árboles de decisión, donde cada árbol se construye de manera secuencial para minimizar la función de costo global, que es la suma de las funciones de costo individuales de cada árbol.</p>
<p>El algoritmo XGBoost también utiliza técnicas de regularización para evitar el sobreajuste, lo que ayuda a mejorar el rendimiento en conjuntos de datos no visto. Estás técnicas incluyen la poda de árboles, la penalización <span class="math inline">\(L_1\)</span> y <span class="math inline">\(L_2\)</span>, y el muestreo aleatorio de observaciones y variables.</p>
<p>Una característica del modelo XGBoost es que puede trabajar con tados a lo bruto (es decir, bases que contengan datos faltantes), es tan robusto que puede trabajar con este tipo de datos.</p>
</section>
<section id="modelo-xgboost-matemáticamente" class="level2">
<h2 class="anchored" data-anchor-id="modelo-xgboost-matemáticamente">Modelo XGBoost Matemáticamente</h2>
<p>El modelo XGBoost se construye a través de una combinación de árboles de decisión y técnicas de optimización de gradiente. En términos matemáticos el modelo XGBoost se puede escribir como:</p>
<p><span class="math display">\[
f(x) = \sum T(x;\theta_j)
\]</span></p>
<p>donde <span class="math inline">\(f(x)\)</span> es la función de predicción para el conjunto de características de entrada <span class="math inline">\(x\)</span>, <span class="math inline">\(T(x;\theta_j)\)</span> es un árbol de decisión con parámetros <span class="math inline">\(\theta_j\)</span>, y la suma se realiza sobre un conjunto de árboles de decisión.</p>
<p>Cada árbol de decisión se construye de manera secuencial para minimizar la función de costo global, que es la suma de las funciones de costo individuales de cada árbol, es decir:</p>
<p><span class="math display">\[L = \sum l(y_i,f_i(x_i)) + \sum \Omega(\theta_j)\]</span></p>
<p>donde <span class="math inline">\(l(y_i, f_i(x_i))\)</span> es la función de costo para el i-ésimo ejemplo de entrenamiento, <span class="math inline">\(f_i(x_i)\)</span> es la predicción del modelo para el i-ésimo ejemplo de entrenamiento,y <span class="math inline">\(\Omega(\theta_j)\)</span> es la penalización para el j-ésimo árbol de decisión, diseñada para evitar el sobreajuste.</p>
<p>La función de costo se puede escribir de varias maneras, dependiendo del problema específico. Por ejemplo, en un problema de regresión, la función de costo podría ser el <code>error cuadrático medio (MSE)</code>, mientras que en un problema de clasificación, la función de costo podría ser la <code>antropía cruzada</code>.</p>
<p>Para construir el modelo XGBoost, se utilizan técnicas de optimización de gradiente para minimizar la función de costo global. Estas técnicas implican calcular las derivadas de la función de costo con respecto a los parámetros del modelo, y ajustar los parámetros en consecuencia.</p>
<p>Además, XGBoost utiliza técnicas de regularización para evitar el sobreajuste, como la poda de árboles, la penalización <span class="math inline">\(L_1\)</span> y <span class="math inline">\(L_2\)</span>, y el muestreo aleatorio de observaciones y variables.</p>
<p>En resumen, el modelo <code>XGBoost</code> se construye a través de una combinación de árboles de decisión y técnicas de optimización de gradiente, con el objetivo de minimizar la función de costo global mientras se aplica la regularización para evitar el sobreajuste.</p>
</section>
<section id="xgboost-para-series-de-tiempo" class="level2">
<h2 class="anchored" data-anchor-id="xgboost-para-series-de-tiempo">XGBoost para series de tiempo</h2>
<p>XGBoost también puede ser aplicado a problemas de series de tiempo. Sin embargo, es importante tener en cuenta que la aplicación del modelo a datos de series de tiempo requiere un enfoque ligeramente diferente en comparación con los problemas de clasificación y regresión estándar.</p>
<p>Para aplicar XGBoost a datos de series de tiempo, es necesario crear características adecuadas para el modelo, lo que puede incluir características basadas en ventanas moviles, diferencias y tasas de cambio. También es importante considerar la estacionalidad y las tendencias en los datos de series de tiempo y aplicar técnicas de preprocesamiento de datos y validación cruzada adecuadas para este tipo de problemas.</p>
<p>Además, se deben tener en cuenta algunas consideraciones especiales en la configuración de características relevantes para la serie de tiempo y la selección de la función de costo y métricas de evaluación adecuadas.</p>
</section>
</section>
<section id="caso-de-estudio" class="level1">
<h1>Caso de estudio</h1>
<section id="cargar-datos" class="level3">
<h3 class="anchored" data-anchor-id="cargar-datos">Cargar datos</h3>
<p>La entrada a MLForecast siempre es un marco de datos en formato de columnas: <code>unique_id</code>, <code>ds</code> y <code>y</code>.</p>
<ul>
<li><p><code>unique_id</code> (cadena, int o categorías) representa un identificador para la serie.</p></li>
<li><p><code>ds</code> (marca de fecha o int) debe ser una hora de indexación entera o una marca de fecha idealmente como AAAA-MM-DD para una fecha o AAAA-MM-DD HH: MM:SS para una marca de tiempo.</p></li>
<li><p><code>y</code> (numérico) representa la medida que deseamos pronósticar</p></li>
</ul>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manipulación y Tratamiento de Datos </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Gráficos o Plots  </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> ticker</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"fivethirtyeight"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"lines.linewidth"</span>] <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>dark_style <span class="op">=</span> {</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.facecolor"</span>: <span class="st">"#212946"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.facecolor"</span>: <span class="st">"212946"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.facecolor"</span>:<span class="st">"212946"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.grid"</span>:<span class="va">True</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.grid.which"</span>: <span class="st">"both"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.top"</span>: <span class="va">False</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.spines.bottom"</span>: <span class="va">False</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid.color"</span>: <span class="st">"#2A3459"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid.linewidth"</span>: <span class="st">"1"</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"text.color"</span>:<span class="st">"0.9"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelcolor"</span>: <span class="st">"0.9"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.color"</span>: <span class="st">"0.9"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.color"</span>: <span class="st">"0.9"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"font.size"</span>: <span class="dv">12</span>}</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update(dark_style)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Tamaño del gráfico </span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylab <span class="im">import</span> rcParams</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>rcParams[<span class="st">"figure.figsize"</span>] <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">5</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Ocultar Warnings </span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Y_df <span class="op">=</span> pd.read_csv(<span class="st">'https://datasets-nixtla.s3.amazonaws.com/ERCOT-clean.csv'</span>, parse_dates<span class="op">=</span>[<span class="st">'ds'</span>])</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Y_df <span class="op">=</span> Y_df.query(<span class="st">"ds &gt;= '2022-01-01' &amp; ds &lt;= '2022-10-01'"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data <span class="op">=</span> Y_df, x <span class="op">=</span> <span class="st">"ds"</span>, y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> <span class="st">"Consumo Energía"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-3-output-1.png" width="931" height="449"></p>
</div>
</div>
<p>Note que esta serie presenta patrones estacionales.</p>
<p>Ajuste y Pronóstico del modelo XGBRegressor</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Biblioteca de Modelos a utilizar</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast <span class="im">import</span> MLForecast</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlforecast.target_transforms <span class="im">import</span> Differences</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    lgb.LGBMRegressor(),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    xgb.XGBRegressor()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mlf <span class="op">=</span> MLForecast(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    models<span class="op">=</span>models,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    freq<span class="op">=</span><span class="st">'H'</span>, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    target_transforms<span class="op">=</span>[Differences([<span class="dv">24</span>])],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    lags<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">25</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>crossvalidation_df <span class="op">=</span> mlf.cross_validation(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>Y_df,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    window_size<span class="op">=</span><span class="dv">24</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    n_windows<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000689 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5784, number of used features: 24
[LightGBM] [Info] Start training from score 20.459896
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000586 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5808, number of used features: 24
[LightGBM] [Info] Start training from score 16.278110
[LightGBM] [Warning] Auto-choosing row-wise multi-threading, the overhead of testing was 0.000911 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5832, number of used features: 24
[LightGBM] [Info] Start training from score 14.804025
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000575 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5856, number of used features: 24
[LightGBM] [Info] Start training from score 8.046411
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000572 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5880, number of used features: 24
[LightGBM] [Info] Start training from score -4.761817
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000566 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5904, number of used features: 24
[LightGBM] [Info] Start training from score 4.125424
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000579 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5928, number of used features: 24
[LightGBM] [Info] Start training from score 20.682681
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000622 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5952, number of used features: 24
[LightGBM] [Info] Start training from score 22.922998
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000592 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 5976, number of used features: 24
[LightGBM] [Info] Start training from score 19.915449
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000584 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6000, number of used features: 24
[LightGBM] [Info] Start training from score 17.515171
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000528 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6024, number of used features: 24
[LightGBM] [Info] Start training from score 12.423390
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000592 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6048, number of used features: 24
[LightGBM] [Info] Start training from score 6.484496
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000588 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6072, number of used features: 24
[LightGBM] [Info] Start training from score 11.567787
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000590 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6096, number of used features: 24
[LightGBM] [Info] Start training from score 14.818267
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000618 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6120, number of used features: 24
[LightGBM] [Info] Start training from score 12.293849
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000604 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6144, number of used features: 24
[LightGBM] [Info] Start training from score 11.707901
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000639 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6168, number of used features: 24
[LightGBM] [Info] Start training from score 22.758710
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000591 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6192, number of used features: 24
[LightGBM] [Info] Start training from score 25.677967
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000567 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6216, number of used features: 24
[LightGBM] [Info] Start training from score 26.444992
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000626 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6240, number of used features: 24
[LightGBM] [Info] Start training from score 34.442383
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000597 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6264, number of used features: 24
[LightGBM] [Info] Start training from score 36.212792
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000607 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6288, number of used features: 24
[LightGBM] [Info] Start training from score 32.396612
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000611 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6312, number of used features: 24
[LightGBM] [Info] Start training from score 28.624504
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000558 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6336, number of used features: 24
[LightGBM] [Info] Start training from score 28.720802
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000605 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6360, number of used features: 24
[LightGBM] [Info] Start training from score 22.527080
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000614 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6384, number of used features: 24
[LightGBM] [Info] Start training from score 19.823470
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000577 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6408, number of used features: 24
[LightGBM] [Info] Start training from score 11.739053
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000587 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6432, number of used features: 24
[LightGBM] [Info] Start training from score -3.854454
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000588 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6456, number of used features: 24
[LightGBM] [Info] Start training from score -3.066119
[LightGBM] [Warning] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000614 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 6120
[LightGBM] [Info] Number of data points in the train set: 6480, number of used features: 24
[LightGBM] [Info] Start training from score -7.603843</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>crossvalidation_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unique_id</th>
<th data-quarto-table-cell-role="th">ds</th>
<th data-quarto-table-cell-role="th">cutoff</th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">LGBMRegressor</th>
<th data-quarto-table-cell-role="th">XGBRegressor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ERCOT</td>
<td>2022-09-01 00:00:00</td>
<td>2022-08-31 23:00:00</td>
<td>45482.471757</td>
<td>45685.265537</td>
<td>45802.578125</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ERCOT</td>
<td>2022-09-01 01:00:00</td>
<td>2022-08-31 23:00:00</td>
<td>43602.658043</td>
<td>43779.819515</td>
<td>43921.304688</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ERCOT</td>
<td>2022-09-01 02:00:00</td>
<td>2022-08-31 23:00:00</td>
<td>42284.817342</td>
<td>42672.470923</td>
<td>42752.031250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>ERCOT</td>
<td>2022-09-01 03:00:00</td>
<td>2022-08-31 23:00:00</td>
<td>41663.156771</td>
<td>42091.768192</td>
<td>42021.394531</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>ERCOT</td>
<td>2022-09-01 04:00:00</td>
<td>2022-08-31 23:00:00</td>
<td>41710.621904</td>
<td>42481.403168</td>
<td>42240.070312</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Al usar, <code>cross_validation</code> asegúrese de que los pronósticos se produzcan en las marcas de tiempo deseadas. Verifique la columna <code>cutoff</code> que especifica la última marca de tiempo antes de la ventana de pronósticos.</p>
</section>
<section id="detección-de-picos" class="level3">
<h3 class="anchored" data-anchor-id="detección-de-picos">Detección de Picos</h3>
<p>Finalmente usamos los pronósticos para <code>crossvaldation_df</code> detectar los picos de demanda diarios por hora. Para cada día, establecemos los picos detectados como los pronósticos más altos. En este caso, queremos predecir un pico (<code>npeaks</code>); dependiendo de su configuración y objetivos, este parámetro puede cambiar. Por ejemplo, el número de picos puede corresponder a cuántas horas se puede descargar una batería para reducir la demanda</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>npeaks <span class="op">=</span> <span class="dv">1</span> <span class="co"># Número de picos </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para la tarea de detección ERCOT nos interesa predecir correctamente la carga mensual más alta. A continuación, filtramos el día de septiembre con la mayor demanda horaria y predecimos el pico.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>crossvalidation_df <span class="op">=</span> crossvalidation_df.reset_index()[[<span class="st">'ds'</span>,<span class="st">'y'</span>,<span class="st">'LGBMRegressor'</span>]]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>max_day <span class="op">=</span> crossvalidation_df.iloc[crossvalidation_df[<span class="st">'y'</span>].argmax()].ds.day <span class="co"># Day with maximum load</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>cv_df_day <span class="op">=</span> crossvalidation_df.query(<span class="st">'ds.dt.day == @max_day'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>max_hour <span class="op">=</span> cv_df_day[<span class="st">'y'</span>].argmax()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>peaks <span class="op">=</span> cv_df_day[<span class="st">'LGBMRegressor'</span>].argsort().iloc[<span class="op">-</span>npeaks:].values <span class="co"># Predicted peaks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El siguiente gráfico vemos cómo el modelo LightGBM es capaz de detectar correctamente el pico coincidente de septiembre 2022.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>ax.axvline(cv_df_day.iloc[max_hour][<span class="st">'ds'</span>], color<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'True Peak'</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ax.scatter(cv_df_day.iloc[peaks][<span class="st">'ds'</span>], cv_df_day.iloc[peaks][<span class="st">'LGBMRegressor'</span>], color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="ss">f'Predicted Top-</span><span class="sc">{</span>npeaks<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax.plot(cv_df_day[<span class="st">'ds'</span>], cv_df_day[<span class="st">'y'</span>], label<span class="op">=</span><span class="st">'y'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ax.plot(cv_df_day[<span class="st">'ds'</span>], cv_df_day[<span class="st">'LGBMRegressor'</span>], label<span class="op">=</span><span class="st">'Forecast'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Time'</span>, ylabel<span class="op">=</span><span class="st">'Load (MW)'</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>ax.grid()</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="index_files/figure-html/cell-11-output-1.png" width="796" height="449"></p>
</div>
</div>
</section>
</section>
<section id="referencias" class="level1">
<h1>Referencias</h1>
<p><a href="https://otexts.com/fpp3/tscv.html#">Rob J.Hyndman y George Athanasopoulos (2018). “Principios y Prácticas de pronósticos, validación cruzada de series de tiempo”</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="Isaula/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© Copyright 2022 Juan Isaula</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>